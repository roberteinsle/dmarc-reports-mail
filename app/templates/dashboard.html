{% extends "base.html" %}

{% block title %}Dashboard - DMARC Reports Mail{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>DMARC Reports Dashboard</h1>
    <button id="triggerProcessing" class="btn btn-primary">
        <i class="bi bi-arrow-clockwise"></i> Process Reports Now
    </button>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Reports</h5>
                <h2>{{ total_reports }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">Alerts Sent</h5>
                <h2>{{ total_alerts }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Pass Rate</h5>
                <h2>{{ pass_rate }}%</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Recent Reports</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Reporter</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in recent_reports %}
                        <tr>
                            <td><a href="/reports/{{ report.id }}">{{ report.domain }}</a></td>
                            <td>{{ report.org_name }}</td>
                            <td><span class="badge bg-{{ 'success' if report.status == 'processed' else 'warning' }}">{{ report.status }}</span></td>
                            <td>{{ report.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5>Recent Alerts</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for alert in recent_alerts %}
                        <tr>
                            <td>{{ alert.alert_type }}</td>
                            <td><span class="badge severity-{{ alert.severity }}">{{ alert.severity }}</span></td>
                            <td>{{ alert.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('triggerProcessing').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

    fetch('/api/trigger-processing', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('✓ Report processing started successfully!\n\nCheck the logs or refresh the page in a moment to see new reports.');
            setTimeout(() => location.reload(), 3000);
        } else {
            alert('✗ Error: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Process Reports Now';
        }
    })
    .catch(error => {
        alert('✗ Network error: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Process Reports Now';
    });
});
</script>
{% endblock %}
